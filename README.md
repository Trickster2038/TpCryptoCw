# CRNL: Commit-reveal numeric lottery

Учебный проект в рамках курса "Разработчик криптографических протоколов и децентрализованных систем". Смарт-контракт представляет собой реализацию математической игры "угадать 2/3  среднего" на базе паттерна commit-reveal.

## Состав файлов
- helper/helper.py - Вспомогательная программа, позволяющая генерировать хеш sha256 на основе двух чисел (загадываемого числа и "соли") по алгоритму совпадающему с алгоритмом, используемым при проверке в смарт-контракте.
- src/contracts/ICRNL.sol - интерфейс основного контракта
- src/contracts/CRNL.sol  - основной контракт
- src/contracts/liteCRNL.sol - наследуемый от основного контракта контракт с упрощенным конструктором
- src/tests/test_CRNL.py - тесты для основновного и lite контракта

## Сборка проекта
Перед началом использования проекта необходимо установить ряд python-библиотек
```
$ pip install pytest
$ pip install hashlib
```
Далее - перейти в папку solidity-проекта и скомпилировать его
```
$ cd src
$ brownie compile
```
После этого можно запустить заготовленные тесты
```
$ brownie test
```
Или перейти к ручному тестированию (основные методы контракта см. в исходном коде или в test_CRNL.py)
```
$ brownie console
```
## Результаты тестов

## Структура тестов
В основном тесты покрывают следущие условия:
- нормальное взаимодействие с контрактом + проверка измения балансов
- проверка работы модификаторов времени (каждая фаза работы контракта: commit, reveal, reward, distruct доступна ограниченное время)
- проверка последовательности этапов (транзакция отклоняется при попытке reveal без commit до этого и т.д.)
- проверка невозможности повторного вызова commit, reveal, подсчета награды и взятия награды (однако есть отдельный метод, позволяющий изменить hash загаднного числа на фазе commit)
- проверка правильности разделения наград и распределения комиссий
- проверка невозможности reveal при невысовпадении хеша загаданного числа с хешем на фазе commit
- проверка выплаты наград за уничтожение контракта
- проверка передачи прав владения контрактом

## Базовая схема взаимодествия с контрактом
- deploy контракта - задаются ограничения, размер ставки и комиссий, временные интервалы этапов работы
- commit - отправка hash(N+salt) и выплата ставки, гарантии reveal и комиссий
- reveal - отправка N, salt - проверка совпадения хешей, возвращение средств гарантировавших reveal при успехе
- подсчет 2/3 среднего N и минимальной разницы между Ni и 2/3 AVG  - в качестве мотивации к вызову метода выступает возврат ставки и выплата дополнительной комиссии вызывающему
- каждый участник вызывает takeReward( ), если Ni = min(|Ni-2/3 AVG|) - выплачивается награда
- вызывается уничтожение контракта - награду получает owner или вызывающий (зависит от параметров, настроенных в конструкторе)

